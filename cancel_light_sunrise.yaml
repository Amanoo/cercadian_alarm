blueprint:
  name: Cancel Light Sunrise on Manual Change
  description: >
    Cancels a running Light Sunrise script when the user manually changes
    the target light. Uses Home Assistant context to distinguish user
    changes from script-driven changes â€” any change made through the HA
    UI or API cancels immediately, regardless of size. A fallback threshold
    catches physical switch / remote changes that lack HA context.
  domain: automation
  input:
    target_light:
      name: ðŸ’¡ Target Light
      description: The light to monitor for manual changes.
      selector:
        entity:
          filter:
            domain: light

    sunrise_script:
      name: ðŸ“„ Sunrise Script
      description: The Light Sunrise script entity to cancel.
      default: script.light_sunrise
      selector:
        entity:
          filter:
            domain: script

    physical_brightness_threshold:
      name: ðŸ”† Physical Change Brightness Threshold (%)
      description: >-
        Fallback threshold for physical switch / remote changes that
        have no HA context. Changes via the HA UI always cancel instantly
        regardless of this value.
      default: 3
      selector:
        number:
          min: 1
          max: 50
          step: 1
          mode: slider

    physical_kelvin_threshold:
      name: ðŸŒ¡ï¸ Physical Change Kelvin Threshold
      description: >-
        Fallback Kelvin threshold for physical / remote changes.
        Changes via the HA UI always cancel instantly regardless of this value.
      default: 30
      selector:
        number:
          min: 10
          max: 500
          step: 10
          mode: slider

variables:
  sunrise_script_entity: !input sunrise_script
  bright_threshold: !input physical_brightness_threshold
  kelv_threshold: !input physical_kelvin_threshold

triggers:
  - entity_id: !input target_light
    trigger: state

conditions:
  # Script must be running
  - condition: template
    value_template: "{{ states(sunrise_script_entity) == 'on' }}"

  # Ignore changes caused by automations / scripts (the sunrise script itself)
  - condition: template
    value_template: >
      {{ trigger.to_state.context.parent_id is none
         or trigger.to_state.context.parent_id == '' }}

  # Cancel on:
  #   - Any user change via HA UI/API (user_id is set) â€” no threshold
  #   - Light turned off by any means
  #   - Physical/external change exceeding the fallback threshold
  - condition: template
    value_template: >
      {% set is_user = trigger.to_state.context.user_id is not none
                        and trigger.to_state.context.user_id != '' %}
      {% set is_off = trigger.to_state.state == 'off' %}
      {% if is_user or is_off %}
        true
      {% else %}
        {% set old_bri = trigger.from_state.attributes.brightness | int(0) %}
        {% set new_bri = trigger.to_state.attributes.brightness | int(0) %}
        {% set old_k = trigger.from_state.attributes.color_temp_kelvin | int(0) %}
        {% set new_k = trigger.to_state.attributes.color_temp_kelvin | int(0) %}
        {{ (new_bri - old_bri) | abs > (255 * bright_threshold / 100)
           or (new_k - old_k) | abs > kelv_threshold }}
      {% endif %}

actions:
  - target:
      entity_id: "{{ sunrise_script_entity }}"
    action: script.turn_off

mode: single
